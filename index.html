<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iPad Visitor Log</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#34c759" />

  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="logo.png" />

  <style>
    :root{
      --muted: #6b7280;
      --radius: 20px;

      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);

      --font-base: 18px;
      --font-lg: 20px;
      --font-xl: 30px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #ffffff;
      margin: 0;
      padding: calc(16px + var(--sat)) calc(16px + var(--sar)) calc(16px + var(--sab)) calc(16px + var(--sal));
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      overflow: hidden;
      overscroll-behavior: none;
    }

    .container {
      height: calc(100dvh - (16px + var(--sat)) - (16px + var(--sab)));
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: var(--radius);
      box-shadow: none;
      display: flex;
      flex-direction: column;
      padding: 18px;
      gap: 14px;
      min-height: 0;
    }

    /* ===== Header ===== */
    .app-header {
      display: grid;
      grid-template-columns: 240px 1fr 240px;
      gap: 10px;
      align-items: center;
      padding: 16px 18px;
      border-radius: 18px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    .logo-wrap {
      background: transparent;
      border-radius: 16px;
      padding: 0;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    .logo-wrap img {
      max-width: 200px;
      width: 100%;
      height: auto;
    }

    /* Make logo tappable */
    .logo-wrap img[role="button"]{
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }
    .logo-wrap img[role="button"]:active{
      transform: scale(0.99);
    }

    .title-wrap {
      text-align: center;
      justify-self: center;
    }

    .title-wrap h1 {
      margin: 0;
      font-size: var(--font-xl);
      font-weight: 800;
      letter-spacing: -0.02em;
      color: #111827;
      line-height: 1.1;
    }

    .subtitle {
      margin-top: 6px;
      font-size: var(--font-base);
      color: var(--muted);
      font-weight: 650;
    }

    /* ===== Language flag button (top-right) ===== */
    .lang-wrap{
      display:flex;
      justify-content:flex-end;
      align-items:center;
    }

    .lang-flag{
      width: 54px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      display: grid;
      place-items: center;
      font-size: 24px;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .lang-flag:active{ background: #f3f4f6; }

    /* ===== Form ===== */
    .form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form .fullrow { grid-column: 1 / -1; }

    input {
      width: 100%;
      font-size: var(--font-lg);
      padding: 14px 14px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #fff;
      outline: none;
    }

    input:focus {
      border-color: #34c759;
      box-shadow: 0 0 0 3px rgba(52,199,89,0.20);
    }

    /* ===== Buttons ===== */
    .buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    button {
      font-size: var(--font-lg);
      padding: 16px 18px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .sign-in { background: #34c759; color: #fff; }
    .sign-out { background: #ff3b30; color: #fff; }

    /* ===== Lists ===== */
    .panes {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      min-height: 0;
    }

    .pane {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .pane h2 {
      margin: 4px 0 10px;
      font-size: 20px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .count {
      font-size: 14px;
      color: var(--muted);
      font-weight: 800;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      min-height: 0;
      border-radius: 12px;
    }

    li {
      background: #f9fafb;
      margin: 8px 0;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: var(--font-base);
      cursor: pointer;
      border: 1px solid #eef0f4;

      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .li-text {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .li-name {
      font-weight: 750;
      color: #111827;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .li-company {
      font-size: 14px;
      color: var(--muted);
      font-weight: 650;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .delete-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 20px;
      line-height: 1;
      padding: 0;
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    .delete-btn:active {
      background: #fee2e2;
      border-color: #fecaca;
    }

    /* ===== Modals ===== */
    [hidden] { display: none !important; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 22px;
      border-radius: 16px;
      max-width: 420px;
      width: min(92vw, 420px);
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
    }

    .modal h3 { font-size: 22px; margin: 0 0 10px; }
    .modal p { margin: 0 0 14px; color: #111827; }

    .modal-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .modal-buttons.one { grid-template-columns: 1fr; }

    .modal-buttons button { font-size: 18px; padding: 12px; border-radius: 12px; }
    .yes { background: #34c759; color: white; }
    .no { background: #ff3b30; color: white; }

    /* ===== Bigger Induction Modal Only ===== */
    #confirmModal .modal {
      max-width: 520px;
      width: min(95vw, 520px);
      padding: 34px 28px;
    }
    #confirmModal .modal h3 { font-size: 28px; }
    #confirmModal .modal p { font-size: 22px; margin-bottom: 22px; }
    #confirmModal .modal-buttons button { font-size: 22px; padding: 18px 16px; border-radius: 14px; }

    @media (max-width: 900px) {
      .app-header { grid-template-columns: 1fr; text-align: center; gap: 12px; }
      .logo-wrap { justify-content: center; }
      .lang-wrap { justify-content: center; }
      .form { grid-template-columns: 1fr; }
      .form .fullrow { grid-column: auto; }
      .buttons { grid-template-columns: 1fr; }
      .panes { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- Modals -->
  <div id="confirmModal" hidden aria-modal="true" role="dialog" aria-labelledby="confirmTitle">
    <div class="modal-backdrop" data-close="confirm"></div>
    <div class="modal">
      <h3 id="confirmTitle"></h3>
      <p id="confirmQuestion"></p>
      <div class="modal-buttons">
        <button class="yes" id="confirmYes"></button>
        <button class="no" id="confirmNo"></button>
      </div>
    </div>
  </div>

  <div id="passcodeModal" hidden aria-modal="true" role="dialog" aria-labelledby="passcodeTitle">
    <div class="modal-backdrop" data-close="passcode"></div>
    <div class="modal">
      <h3 id="passcodeTitle"></h3>
      <input type="password" id="passcodeInput" inputmode="numeric" autocomplete="one-time-code" />
      <div class="modal-buttons">
        <button class="yes" id="passcodeSubmit"></button>
        <button class="no" id="passcodeCancel"></button>
      </div>
    </div>
  </div>

  <div id="exportConfirmModal" hidden aria-modal="true" role="dialog" aria-labelledby="exportTitle">
    <div class="modal-backdrop" data-close="export"></div>
    <div class="modal">
      <h3 id="exportTitle"></h3>
      <p id="exportMsg"></p>
      <div class="modal-buttons one">
        <button class="yes" id="exportOk"></button>
      </div>
    </div>
  </div>

  <div id="deleteConfirmModal" hidden aria-modal="true" role="dialog" aria-labelledby="deleteTitle">
    <div class="modal-backdrop" data-close="delete"></div>
    <div class="modal">
      <h3 id="deleteTitle"></h3>
      <p id="deleteText"></p>
      <div class="modal-buttons">
        <button class="yes" id="deleteYes"></button>
        <button class="no" id="deleteNo"></button>
      </div>
    </div>
  </div>

  <main class="container">
    <header class="app-header">
      <div class="logo-wrap">
        <!-- Logo now triggers Generate Report flow -->
        <img id="logoBtn" src="logo.png" alt="Company Logo" role="button" tabindex="0" />
      </div>

      <div class="title-wrap">
        <h1 id="hdrTitle"></h1>
        <div class="subtitle" id="hdrSub"></div>
      </div>

      <div class="lang-wrap">
        <button class="lang-flag" id="langBtn" type="button" aria-label="Switch language"></button>
      </div>
    </header>

    <!-- Name fields row, company field below -->
    <section class="form" aria-label="Sign in form">
      <input id="firstNameInput" autocomplete="given-name" />
      <input id="lastNameInput" autocomplete="family-name" />
      <input id="companyInput" class="fullrow" autocomplete="organization" />
    </section>

    <section class="buttons">
      <button class="sign-in" id="signInBtn"></button>
      <button class="sign-out" id="signOutBtn"></button>
    </section>

    <section class="panes">
      <div class="pane">
        <h2>
          <span id="activeHeader"></span>
          <span class="count" id="activeCount">0</span>
        </h2>
        <ul id="activeList"></ul>
      </div>

      <div class="pane">
        <h2>
          <span id="historyHeader"></span>
          <span class="count" id="historyCount">0</span>
        </h2>
        <ul id="historyList"></ul>
      </div>
    </section>

    <!-- Export button removed -->
  </main>

  <script>
    // ---- Service Worker Register ----
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js");
      });
    }

    // ---- i18n strings ----
    const I18N = {
      en: {
        hdrTitle: "Project Argo",
        hdrSub: "CDM Area â€“ Visitor Sign In / Out",

        firstPh: "First name",
        lastPh: "Last name",
        companyPh: "Company",

        signIn: "Sign In",
        signOut: "Sign Out",
        activeHeader: "Currently Signed In",
        historyHeader: "Previously Signed In",
        exportBtn: "Generate Report",

        confirmTitle: "Induction Confirmation",
        confirmQuestion: "Have you been inducted?",
        yes: "Yes",
        no: "No",

        passcodeTitle: "Enter Passcode",
        passcodePh: "Enter passcode",
        submit: "Submit",
        cancel: "Cancel",

        exportTitle: "CSV Export",
        exportMsg: "Your CSV has been downloaded.",
        ok: "OK",

        deleteTitle: "Delete Name",
        deletePrompt: (name, company) => `Delete "${name}" (${company}) from the previous list?`,
        delete: "Delete",

        alertMissing: "Please enter first name, last name, and company",
        alertAlreadyIn: "You are already signed in",
        alertNotIn: "You are not currently signed in",
        alertBadCode: "Incorrect passcode",

        flag: "ðŸ‡¬ðŸ‡§",
        flagTitle: "Switch to Chinese"
      },
      zh: {
        hdrTitle: "é˜¿å°”æˆˆé¡¹ç›®",
        hdrSub: "CDM åŒºåŸŸ â€“ è®¿å®¢ç™»è®°ï¼ˆç­¾åˆ° / ç­¾é€€ï¼‰",

        firstPh: "åå­—",
        lastPh: "å§“æ°",
        companyPh: "å…¬å¸",

        signIn: "ç­¾åˆ°",
        signOut: "ç­¾é€€",
        activeHeader: "å½“å‰å·²ç­¾åˆ°",
        historyHeader: "æ›¾ç»ç­¾åˆ°",
        exportBtn: "ç”ŸæˆæŠ¥å‘Š",

        confirmTitle: "å…¥åœºç¡®è®¤",
        confirmQuestion: "æ‚¨å·²å®Œæˆå…¥åœºåŸ¹è®­/å®£å¯¼å—ï¼Ÿ",
        yes: "æ˜¯",
        no: "å¦",

        passcodeTitle: "è¾“å…¥å¯†ç ",
        passcodePh: "è¯·è¾“å…¥å¯†ç ",
        submit: "æäº¤",
        cancel: "å–æ¶ˆ",

        exportTitle: "å¯¼å‡º CSV",
        exportMsg: "CSV å·²ä¸‹è½½ã€‚",
        ok: "ç¡®å®š",

        deleteTitle: "åˆ é™¤å§“å",
        deletePrompt: (name, company) => `ç¡®å®šä»ŽåŽ†å²åˆ—è¡¨åˆ é™¤â€œ${name}â€ï¼ˆ${company}ï¼‰å—ï¼Ÿ`,
        delete: "åˆ é™¤",

        alertMissing: "è¯·è¾“å…¥åå­—ã€å§“æ°å’Œå…¬å¸",
        alertAlreadyIn: "æ‚¨å·²ç»ç­¾åˆ°",
        alertNotIn: "æ‚¨å½“å‰æœªç­¾åˆ°",
        alertBadCode: "å¯†ç é”™è¯¯",

        flag: "ðŸ‡¨ðŸ‡³",
        flagTitle: "åˆ‡æ¢åˆ°è‹±æ–‡"
      }
    };

    // ---- Language state ----
    const langBtn = document.getElementById("langBtn");
    let lang = localStorage.getItem("lang") || "en";

    // ---- Data ----
    let visits = JSON.parse(localStorage.getItem("visits")) || [];
    let previousNames = JSON.parse(localStorage.getItem("previousNames")) || {};

    // ---- Elements ----
    const firstNameInput = document.getElementById("firstNameInput");
    const lastNameInput = document.getElementById("lastNameInput");
    const companyInput = document.getElementById("companyInput");

    const activeList = document.getElementById("activeList");
    const historyList = document.getElementById("historyList");
    const activeCount = document.getElementById("activeCount");
    const historyCount = document.getElementById("historyCount");

    const confirmModal = document.getElementById("confirmModal");
    const passcodeModal = document.getElementById("passcodeModal");
    const exportConfirmModal = document.getElementById("exportConfirmModal");
    const deleteConfirmModal = document.getElementById("deleteConfirmModal");

    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");

    // Logo acts as export trigger
    const logoBtn = document.getElementById("logoBtn");

    const confirmTitleEl = document.getElementById("confirmTitle");
    const confirmQuestionEl = document.getElementById("confirmQuestion");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");

    const passcodeTitleEl = document.getElementById("passcodeTitle");
    const passcodeInput = document.getElementById("passcodeInput");
    const passcodeSubmit = document.getElementById("passcodeSubmit");
    const passcodeCancel = document.getElementById("passcodeCancel");

    const exportTitleEl = document.getElementById("exportTitle");
    const exportMsgEl = document.getElementById("exportMsg");
    const exportOk = document.getElementById("exportOk");

    const deleteTitleEl = document.getElementById("deleteTitle");
    const deleteText = document.getElementById("deleteText");
    const deleteYes = document.getElementById("deleteYes");
    const deleteNo = document.getElementById("deleteNo");

    const hdrTitleEl = document.getElementById("hdrTitle");
    const hdrSubEl = document.getElementById("hdrSub");
    const activeHeaderEl = document.getElementById("activeHeader");
    const historyHeaderEl = document.getElementById("historyHeader");

    // ---- State ----
    let pendingSignIn = null;
    let pendingAction = null;
    let pendingDeleteName = null;

    // ============================================================
    //  AUTO-CLEAR ALL FIELDS AFTER 10 SECONDS OF INACTIVITY
    // ============================================================
    let idleTimer = null;

    function clearFormFields() {
      firstNameInput.value = "";
      lastNameInput.value = "";
      companyInput.value = "";
    }

    function resetIdleTimer() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        if (
          firstNameInput.value.trim() ||
          lastNameInput.value.trim() ||
          companyInput.value.trim()
        ) {
          clearFormFields();
        }
      }, 10000);
    }

    function stopIdleTimer() {
      clearTimeout(idleTimer);
      idleTimer = null;
    }

    [firstNameInput, lastNameInput, companyInput].forEach((inp) => {
      inp.addEventListener("input", resetIdleTimer);
      inp.addEventListener("focus", resetIdleTimer);
    });

    ["pointerdown", "touchstart", "keydown"].forEach((evt) => {
      document.addEventListener(evt, resetIdleTimer, { passive: true });
    });

    resetIdleTimer();
    // ============================================================

    // ---- Helpers ----
    function openModal(el) { el.hidden = false; }
    function closeModal(el) { el.hidden = true; }
    function t() { return I18N[lang] || I18N.en; }

    function getFullName(first, last) {
      return `${first} ${last}`.trim().replace(/\s+/g, " ");
    }

    // Backdrop close
    document.addEventListener("click", (e) => {
      const target = e.target;
      if (target && target.matches(".modal-backdrop")) {
        const which = target.getAttribute("data-close");
        if (which === "confirm") closeModal(confirmModal);
        if (which === "passcode") closeModal(passcodeModal);
        if (which === "export") closeModal(exportConfirmModal);
        if (which === "delete") closeModal(deleteConfirmModal);
      }
    });

    // Escape close
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      if (!confirmModal.hidden) closeModal(confirmModal);
      if (!passcodeModal.hidden) closeModal(passcodeModal);
      if (!exportConfirmModal.hidden) closeModal(exportConfirmModal);
      if (!deleteConfirmModal.hidden) closeModal(deleteConfirmModal);
    });

    // Enter submits passcode
    passcodeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkPasscode();
    });

    // Buttons
    signInBtn.addEventListener("click", signIn);
    signOutBtn.addEventListener("click", signOut);

    // Logo triggers export request (passcode modal)
    logoBtn.addEventListener("click", requestExport);
    logoBtn.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        requestExport();
      }
    });

    confirmYes.addEventListener("click", () => confirmInduction(true));
    confirmNo.addEventListener("click", () => confirmInduction(false));

    passcodeSubmit.addEventListener("click", checkPasscode);
    passcodeCancel.addEventListener("click", closePasscodeModal);

    exportOk.addEventListener("click", closeExportModal);

    deleteNo.addEventListener("click", () => {
      pendingDeleteName = null;
      closeModal(deleteConfirmModal);
    });

    deleteYes.addEventListener("click", () => {
      if (!pendingDeleteName) return;
      delete previousNames[pendingDeleteName];
      localStorage.setItem("previousNames", JSON.stringify(previousNames));
      pendingDeleteName = null;
      closeModal(deleteConfirmModal);
      render();
    });

    // iOS keyboard friendliness
    [firstNameInput, lastNameInput, companyInput, passcodeInput].forEach((inp) => {
      inp.addEventListener("focus", () => {
        setTimeout(() => inp.scrollIntoView({ block: "center", behavior: "smooth" }), 50);
      });
    });

    // Tap flag to toggle language
    langBtn.addEventListener("click", () => {
      lang = (lang === "en") ? "zh" : "en";
      localStorage.setItem("lang", lang);
      applyLanguage();
      render();
    });

    applyLanguage();
    render();

    function applyLanguage() {
      document.documentElement.lang = (lang === "zh") ? "zh-Hans" : "en";
      const s = t();

      hdrTitleEl.textContent = s.hdrTitle;
      hdrSubEl.textContent = s.hdrSub;

      firstNameInput.placeholder = s.firstPh;
      lastNameInput.placeholder = s.lastPh;
      companyInput.placeholder = s.companyPh;

      signInBtn.textContent = s.signIn;
      signOutBtn.textContent = s.signOut;

      activeHeaderEl.textContent = s.activeHeader;
      historyHeaderEl.textContent = s.historyHeader;

      confirmTitleEl.textContent = s.confirmTitle;
      confirmQuestionEl.textContent = s.confirmQuestion;
      confirmYes.textContent = s.yes;
      confirmNo.textContent = s.no;

      passcodeTitleEl.textContent = s.passcodeTitle;
      passcodeInput.placeholder = s.passcodePh;
      passcodeSubmit.textContent = s.submit;
      passcodeCancel.textContent = s.cancel;

      exportTitleEl.textContent = s.exportTitle;
      exportMsgEl.textContent = s.exportMsg;
      exportOk.textContent = s.ok;

      deleteTitleEl.textContent = s.deleteTitle;
      deleteYes.textContent = s.delete;
      deleteNo.textContent = s.cancel;

      langBtn.textContent = s.flag;
      langBtn.title = s.flagTitle;
      langBtn.setAttribute("aria-label", s.flagTitle);
    }

    function signIn() {
      const first = firstNameInput.value.trim();
      const last = lastNameInput.value.trim();
      const company = companyInput.value.trim();
      const s = t();

      if (!first || !last || !company) return alert(s.alertMissing);

      const fullName = getFullName(first, last);

      if (visits.find(v => v.name === fullName && !v.signOut))
        return alert(s.alertAlreadyIn);

      pendingSignIn = { name: fullName, company };
      openModal(confirmModal);
    }

    function confirmInduction(confirmed) {
      closeModal(confirmModal);
      if (!confirmed) { pendingSignIn = null; return; }

      visits.push({
        name: pendingSignIn.name,
        company: pendingSignIn.company,
        signIn: new Date().toISOString(),
        signOut: null
      });

      previousNames[pendingSignIn.name] = pendingSignIn.company;
      localStorage.setItem("previousNames", JSON.stringify(previousNames));

      pendingSignIn = null;
      save();
    }

    function signOut() {
      const first = firstNameInput.value.trim();
      const last = lastNameInput.value.trim();
      const s = t();

      const fullName = getFullName(first, last);
      const visit = visits.find(v => v.name === fullName && !v.signOut);
      if (!visit) return alert(s.alertNotIn);

      visit.signOut = new Date().toISOString();
      save();
    }

    function save() {
      localStorage.setItem("visits", JSON.stringify(visits));
      firstNameInput.value = "";
      lastNameInput.value = "";
      companyInput.value = "";
      stopIdleTimer();
      resetIdleTimer();
      render();
    }

    function render() {
      activeList.innerHTML = "";
      historyList.innerHTML = "";

      const signedInNames = new Set();
      const active = visits.filter(v => !v.signOut);

      active.forEach(v => {
        const li = document.createElement("li");

        const text = document.createElement("div");
        text.className = "li-text";
        text.innerHTML = `
          <div class="li-name">${escapeHtml(v.name)}</div>
          <div class="li-company">${escapeHtml(v.company)}</div>
        `;

        text.addEventListener("click", () => {
          const parts = String(v.name).split(" ");
          firstNameInput.value = parts.slice(0, -1).join(" ") || "";
          lastNameInput.value = parts.slice(-1).join(" ") || "";
          companyInput.value = v.company;
          resetIdleTimer();
        });

        li.appendChild(text);
        activeList.appendChild(li);
        signedInNames.add(v.name);
      });

      const historyNames = Object.keys(previousNames)
        .filter(name => !signedInNames.has(name))
        .sort((a,b) => a.localeCompare(b));

      historyNames.forEach(name => {
        const company = previousNames[name] || "";
        const li = document.createElement("li");

        const text = document.createElement("div");
        text.className = "li-text";
        text.innerHTML = `
          <div class="li-name">${escapeHtml(name)}</div>
          <div class="li-company">${escapeHtml(company)}</div>
        `;

        text.addEventListener("click", () => {
          const parts = String(name).split(" ");
          firstNameInput.value = parts.slice(0, -1).join(" ") || "";
          lastNameInput.value = parts.slice(-1).join(" ") || "";
          companyInput.value = company;
          resetIdleTimer();
        });

        const del = document.createElement("button");
        del.className = "delete-btn";
        del.type = "button";
        del.textContent = "âœ•";
        del.setAttribute("aria-label", `Delete ${name}`);

        del.addEventListener("click", (e) => {
          e.stopPropagation();
          pendingDeleteName = name;
          deleteText.textContent = t().deletePrompt(name, company);
          openModal(deleteConfirmModal);
          resetIdleTimer();
        });

        li.appendChild(text);
        li.appendChild(del);
        historyList.appendChild(li);
      });

      activeCount.textContent = String(active.length);
      historyCount.textContent = String(historyNames.length);
    }

    // --- Export ---
    function csvEscape(value) {
      const s = String(value ?? "");
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }

    function exportCSV() {
      const header = ["Name", "Company", "Sign In", "Sign Out"];
      const rows = [header];

      visits.forEach(v => rows.push([v.name, v.company, v.signIn, v.signOut || ""]));

      const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n") + "\n";
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);

      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g, "-");
      link.download = `CDM_Visitor_Log_${stamp}.csv`;

      document.body.appendChild(link);
      link.click();
      link.remove();

      visits = [];
      localStorage.setItem("visits", JSON.stringify(visits));

      openModal(exportConfirmModal);
      render();
    }

    function closeExportModal() {
      closeModal(exportConfirmModal);
    }

    function requestExport() {
      pendingAction = "export";
      passcodeInput.value = "";
      openModal(passcodeModal);
      setTimeout(() => passcodeInput.focus(), 50);
      resetIdleTimer();
    }

    function closePasscodeModal() {
      passcodeInput.value = "";
      closeModal(passcodeModal);
      pendingAction = null;
      resetIdleTimer();
    }

    function checkPasscode() {
      if (passcodeInput.value !== "8877") return alert(t().alertBadCode);
      closeModal(passcodeModal);
      if (pendingAction === "export") exportCSV();
      pendingAction = null;
      resetIdleTimer();
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // Prevent pull-to-refresh / page scroll, allow only UL scrolling
    document.addEventListener("touchmove", (e) => {
      const path = e.composedPath ? e.composedPath() : [];
      const inScrollable = path.some(el => el && el.tagName === "UL");
      if (!inScrollable) e.preventDefault();
    }, { passive: false });
  </script>
</body>
</html>
